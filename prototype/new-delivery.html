<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧簽單系統 - 新增簽單</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles/common.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">新增簽單</h1>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form class="row g-3" id="deliveryForm">
                            <!-- 基本資訊 -->
                            <div class="col-md-6">
                                <label class="form-label">客戶名稱</label>
                                <input type="text" class="form-control" list="customerList" name="customer">
                                <datalist id="customerList">
                                    <option value="台北營造公司">
                                    <option value="新北工程行">
                                    <option value="台中營建工程">
                                </datalist>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">日期</label>
                                <input type="date" class="form-control" name="date">
                            </div>

                            <div class="col-12">
                                <label class="form-label">施工地點</label>
                                <input type="text" class="form-control" name="location" placeholder="輸入地址">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">作業狀況</label>
                                <textarea class="form-control" rows="3" name="work"></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">工作時間 (起)</label>
                                <input type="time" class="form-control" name="startTime">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">工作時間 (迄)</label>
                                <input type="time" class="form-control" name="endTime">
                            </div>

                            <!-- 送出按鈕 -->
                            <div class="col-12 mt-4">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="reset" class="btn btn-secondary">
                                        <i class="bi bi-x-lg"></i> 取消
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg"></i> 完成簽單
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 司機資訊（自動填） -->
    <div id="authBadge"></div>
    
    

        <!-- 離線管理與新增簽單腳本 -->
        <script type="module" src="js/offline.js"></script>
        <script type="module" src="js/new-delivery.js"></script>
        <script type="module">
            import { onAuthChange, signOut } from './js/auth.js';

            onAuthChange((user) => {
                const driverElId = 'driverName';
                const vehicleElId = 'vehicleNumber';
                let driverEl = document.getElementById(driverElId);
                let vehicleEl = document.getElementById(vehicleElId);
                if (!driverEl) {
                    // append fields if missing
                    const container = document.querySelector('.card-body form .row') || document.querySelector('.card-body form');
                    const div1 = document.createElement('div');
                    div1.className = 'col-md-6';
                    div1.innerHTML = '<label class="form-label">車號</label><input id="vehicleNumber" type="text" class="form-control" readonly placeholder="請先登入以自動帶入車號">';
                    const div2 = document.createElement('div');
                    div2.className = 'col-md-6';
                    div2.innerHTML = '<label class="form-label">司機姓名</label><input id="driverName" type="text" class="form-control" readonly placeholder="請先登入以自動帶入司機名稱">';
                    container.insertBefore(div1, container.firstChild);
                    container.insertBefore(div2, container.firstChild.nextSibling);
                    driverEl = document.getElementById(driverElId);
                    vehicleEl = document.getElementById(vehicleElId);
                }

                const badge = document.getElementById('authBadge');
                badge.innerHTML = '';
                if (user) {
                    const name = user.displayName || user.email.split('@')[0];
                    if (driverEl) driverEl.value = name;
                    if (vehicleEl) vehicleEl.value = 'V001';
                    badge.innerHTML = `<div class="position-fixed top-0 end-0 m-3"><div class="btn-group"><button class="btn btn-sm btn-outline-primary">歡迎，${name}</button><button id="btnSignOut" class="btn btn-sm btn-outline-danger">登出</button></div></div>`;
                    document.getElementById('btnSignOut').addEventListener('click', async () => {
                        await signOut();
                        if (driverEl) driverEl.value = '';
                        if (vehicleEl) vehicleEl.value = '';
                        window.location.href = './login.html';
                    });
                } else {
                    // redirect to login and remember returnTo
                    const params = new URLSearchParams();
                    params.set('returnTo', window.location.pathname.split('/').pop());
                    window.location.href = `./login.html?${params.toString()}`;
                }
            });
        </script>


</body>
</html>